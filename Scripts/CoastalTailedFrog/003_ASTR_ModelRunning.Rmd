---
title: "Western Skink Species Habitat Model"
author: "Madrone Environmental Services"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---
# Presence & Absence Data Loading

### Filename:

"003_PLSK_RF_Model_V1.Rmd"

### Organization:

Madrone Environmental Services, Ltd.

### Date Created:

March, 1, 2023

### Update:

Formatted according to standards, including final object assignment

### Usage:

Run with R in RStudio, to load your processed environmental parameters (see 002a for Environmental Data Processing) for subsequent use in a SHM to the provincial draft standard. This script is anticipated to follow establishment of presence and absence points (see 001_SpeciesDataLoading.Rmd).

### Inputs:

"PLSK_points_clean" sf from Script 001, "rast_processed" raster stack from Script 002b

### Outputs:

"Outputs/20230222-130736/20230222-130736_map.img", a static map of the habitat model saved to the outputs folder and with a date corresponding to model running timeline. This can be loaded as a raster and spatially saved as convenient as well.  

Created with R 4.1.1 or later, RStudio 2022.12.0 Build 353 or later (may also run in earlier versions).


# Species Habitat Model for western skink (*Plestiodon skiltonianus*)

## Purpose

This script is used to extract habitat data from previously loaded
environmental data (Scripts 002a and 002b), and use it in a Random
Forest model to assess western skink habitat throughout their range.

At the end of this script, users should have a static map, produced as a /*.img file for production as a PDF. This can be saved as a raster or
shapefile as well.

When using this framework, the files are managed under the following
folder structure:

    working directory. 
        Scripts 
        Data 
        Outputs 
        Report

Using this same structure within your working directory should allow
mapped pathways to work effectively. If you standardize your folder
structure, most scripts should run fluidly after completing the
housekeeping steps below.

### House-keeping

This chunk establishes a tool for preparing your libraries, setting your
working directory, and establishing manual entries for the Draft SHM
Standard.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

list.of.packages <- c("tidyverse", "lubridate","chron","bcdata", "bcmaps","sf", "rgdal", "readxl", "Cairo", "wetlandmapR", "ggmap","rgbif","stars", "dismo")
# Check you have them and load them
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(list.of.packages, require, character.only = TRUE)
```

## SHM Model Steps

The first step in the model is to ensure your species location points are loaded and converted to an sp object. In this example, the object is converted from an sf object. Subsequently, the environmental data values for each species point are extracted and used to inform the subsequent model. We use the dismo Maxent model framework for this worked example.

```{r cars}
#PLSK_for_sp <- PLSK_points_clean[-which(st_is_empty(PLSK_points_clean)),]
ASTR_sp <- as_Spatial(ASTR_point_map)
ASTR_sp_bg <- as_Spatial(ASTR_points_withbg)
# witholding a 20% sample for testing 
fold <- kfold(ASTR_sp, k=5)
occtest <- ASTR_sp[fold == 1, ]
occtrain <- ASTR_sp[fold != 1, ]

#me_model1 <- maxent(x = rast_processed,
#                    p = occtrain)

#Attribute training points with intersecting input raster values grouped by provided AOI, write results to CSV. 
training_points <- grid_values_at_sp(x = rast_processed,
                        y= ASTR_sp_bg)

#to save to file
grid_values_at_sp(x = rast_processed,
                  y=training_points,
                  filename = "train_pnts_attributed.csv")

##5 - Setup Predictor list and raster LUT (look up table)

rastLUT <- stack_rasters(rasters = rastlist_names, rastLUTfn = file.path('rastLUT.csv'), aligned = TRUE)

rastLUT_text <- read.csv(file.path("R:/22.0253_SHM_Year2/Worked_Examples/Coastal_Tailed_Frog/Scripts",'rastLUT.csv'),
                     header = FALSE,
                     stringsAsFactors = FALSE)
 
#View rastLUT table 
#rastLUT
 
#subset predictor list - use 2, rownames are excluded from rastLUT, but they're embedded in the obj:
predList <- rastLUT_text[-c(39,50),2]

#Predictor List can also be manually set:
#predList <- names(training_points[c(139:157,180:191)])

#---------------------------------------
#Run model:
#-----------------------------------------------
##RF

model.out <- wetland_model(qdatafn = "train_pnts_attributed.csv",
                           model.type = "RF",
                           model.folder = file.path("R:/22.0253_SHM_Year2/Worked_Examples/Coastal_Tailed_Frog/Outputs"),
                           unique.rowname = "SURVEY_OBSERVATION_ID",
                           predList = predList,
                           predFactor = FALSE,
                           response.name = "OBSERVED_NUMBER",
                           response.type = "binary",
                           seed = 1,
                           aoi.col = NULL)

wetland_map(model.out = model.out,
            model.folder = file.path("R:/22.0253_SHM_Year2/Worked_Examples/Coastal_Tailed_Frog/Outputs"),
            rastLUTfn = rastLUT_text,
            aoi = NULL,
            aoi.col = NULL)

ASTR_model_output <- raster::raster('R:/22.0253_SHM_Year2/Worked_Examples/Coastal_Tailed_Frog/Outputs/20230222-130736/20230222-130736_map.img')
plot(ASTR_model_output)
plot(ASTR_sp, add=TRUE)

#---------------------------------------
#---------------------------------------
#---------------------------------------
#---------------------------------------
#---------------------------------------
#---------------------------------------
#---------------------------------------
#---------------------------------------


rf.out_spac <- rf(data = training_points,
                  dependent.variable.name = "Obs",
                  predictor.variable.names = colnames(training_points)[3:55],
                  distance.matrix = NULL,
                  distance.thresholds = 0,
                  n.cores = 1)

wetland_map(model.out = model.out,
            model.folder = file.path("R:/22.0253_SHM_Year2/Worked_Examples/Western_Skink/Outputs"),
            rastLUTfn = rastLUT_text,
            aoi = NULL,
            aoi.col = NULL)

PLSK_model_output <- raster('R:/22.0253_SHM_Year2/Worked_Examples/Western_Skink/Outputs/20230222-130736/20230222-130736_map.img')
plot(PLSK_model_output)
plot(PLSK_sp, add=TRUE)




















##5 - SAGA Setup Predictor list and raster LUT (look up table)
#Assign URL to output CSV
attributed_csv_saga <- file.path(out_dir,"train_pnts_attributed_saga.csv")
raster::crs(small.stack_saga) <- "EPSG:3005"


#Attribute training points with intersecting input raster values grouped by provided AOI, write results to CSV. 
#training_points <- grid_values_at_sp(x=vcs.rasterSTack,
#                        y=training_points,
#                        aoi = aoi_polys)

#to save to file
grid_values_at_sp(x=small.stack_saga,
                  y=training_points,
                  filename = attributed_csv_saga,
                  aoi = aoi_polys)





rastLUT_saga <- read.csv(file.path(out_dir,'rastLUT_saga.csv'),
                    header = FALSE,
                    stringsAsFactors = FALSE)

#View rastLUT table 
rastLUT_saga

#subset predictor list - use 2, rownames are excluded from rastLUT, but they're embedded in the obj:
predList_saga <- rastLUT_saga[,2]
predList_saga
#Create a model output directory called 'model_output' within 'out_dir' directory
dir.create(file.path(out_dir,"model_output"))


#---------------------------------------
##6 - Run model:

#-----------------------------------------------
##RF

model.out_saga <- wetland_model(qdatafn = attributed_csv_saga,
                           model.type = "RF",
                           model.folder = file.path(out_dir,"model_output"),
                           unique.rowname = "OBJECTID_UNIQUE",
                           predList = predList_saga,
                           predFactor = FALSE,
                           response.name = "pres_nd",
                           response.type = "binary",
                           seed = 1,
                           aoi.col = NULL)

wetland_map(model.out = model.out_saga,
            model.folder = file.path(out_dir,"model_output"),
            rastLUTfn = rastLUT_saga,
            aoi = NULL,
            aoi.col = NULL)

elk_model_output <- raster ('./wetlandmapr/output01/model_output/20220411-101139/20220411-101139_map.img')
plot(elk_model_output)

raster::crs(elk_model_output) <- "EPSG:3005"
writeRaster(elk_model_output,
            filename = "saga_elkmodel","GTiff")
#---------------------------------------
##5 - VRI Setup Predictor list and raster LUT (look up table)
#Assign URL to output CSV
attributed_csv_nosaga <- file.path(out_dir,"train_pnts_attributed_nosaga.csv")
raster::crs(small.stack_NOsaga) <- "EPSG:3005"

#to save to file
grid_values_at_sp(x=small.stack_NOsaga,
                  y=training_points,
                  filename = attributed_csv_nosaga,
                  aoi = aoi_polys)





rastLUT_nosaga <- read.csv(file.path(out_dir,'rastLUT_nosaga.csv'),
                         header = FALSE,
                         stringsAsFactors = FALSE)

#View rastLUT table 
rastLUT_nosaga

#subset predictor list - use 2, rownames are excluded from rastLUT, but they're embedded in the obj:
predList_nosaga <- rastLUT_nosaga[,2]
predList_nosaga
#Create a model output directory called 'model_output' within 'out_dir' directory
dir.create(file.path(out_dir,"model_output"))


#---------------------------------------
##6 - Run model:

#-----------------------------------------------
##RF

model.out_nosaga <- wetland_model(qdatafn = attributed_csv_nosaga,
                                model.type = "RF",
                                model.folder = file.path(out_dir,"model_output"),
                                unique.rowname = "OBJECTID_UNIQUE",
                                predList = predList_nosaga,
                                predFactor = FALSE,
                                response.name = "pres_nd",
                                response.type = "binary",
                                seed = 1,
                                aoi.col = NULL)

wetland_map(model.out = model.out_nosaga,
            model.folder = file.path(out_dir,"model_output"),
            rastLUTfn = rastLUT_nosaga,
            aoi = NULL,
            aoi.col = NULL)

elk_model_output_nosaga <- raster ('./wetlandmapr/output01/model_output/20220418-163436/20220418-163436_map.img')

raster::crs(elk_model_output_nosaga) <- "EPSG:3005"


plot(elk_model_output_nosaga)
plot(clip_points, add=TRUE)

crs(elk_model_output_nosaga)
writeRaster(elk_model_output_nosaga,
            filename = "vri_elkmodel","GTiff")
# #old school - issues with the wetland model:




#---------------------------------------
##5 - Climate Setup Predictor list and raster LUT (look up table)
#Assign URL to output CSV
attributed_csv_clim <- file.path(out_dir,"train_pnts_attributed_clim.csv")
raster::crs(small.stack_climate) <- "EPSG:3005"

#to save to file
grid_values_at_sp(x=small.stack_climate,
                  y=training_points,
                  filename = attributed_csv_clim,
                  aoi = aoi_polys)





rastLUT_clim <- read.csv(file.path(out_dir,'rastLUT_clim.csv'),
                        header = FALSE,
                        stringsAsFactors = FALSE)

#View rastLUT table 
rastLUT_clim

#subset predictor list - use 2, rownames are excluded from rastLUT, but they're embedded in the obj:
predList_clim <- rastLUT_clim[,2]
predList_clim
#Create a model output directory called 'model_output' within 'out_dir' directory
dir.create(file.path(out_dir,"model_output"))


#---------------------------------------
##6 - Run model:

#-----------------------------------------------
##RF

model.out_clim <- wetland_model(qdatafn = attributed_csv_clim,
                               model.type = "RF",
                               model.folder = file.path(out_dir,"model_output"),
                               unique.rowname = "OBJECTID_UNIQUE",
                               predList = predList_clim,
                               predFactor = FALSE,
                               response.name = "pres_nd",
                               response.type = "binary",
                               seed = 1,
                               aoi.col = NULL)

wetland_map(model.out = model.out_clim,
            model.folder = file.path(out_dir,"model_output"),
            rastLUTfn = rastLUT_clim,
            aoi = NULL,
            aoi.col = NULL)

elk_model_output_clim <- raster ('./wetlandmapr/output01/model_output/20220411-132226/20220411-132226_map.img')
raster::crs(elk_model_output_clim) <- "EPSG:3005"


plot(elk_model_output_clim)
plot(clip_points, col = "black", add=TRUE)

writeRaster(elk_model_output_clim,
            filename = "clim_elkmodel","GTiff")

# #old school - issues with the wetland model:
#---------------------------------------
##5 - VRI Setup Predictor list and raster LUT (look up table)
#Assign URL to output CSV
attributed_csv_vri <- file.path(out_dir,"train_pnts_attributed_vri.csv")
raster::crs(small.stack_vri) <- "EPSG:3005"

#to save to file
grid_values_at_sp(x=small.stack_vri,
                  y=training_points,
                  filename = attributed_csv_vri,
                  aoi = aoi_polys)





rastLUT_vri <- read.csv(file.path(out_dir,'rastLUT_vri.csv'),
                           header = FALSE,
                           stringsAsFactors = FALSE)

#View rastLUT table 
rastLUT_vri

#subset predictor list - use 2, rownames are excluded from rastLUT, but they're embedded in the obj:
predList_vri <- rastLUT_vri[,2]
predList_vri
#Create a model output directory called 'model_output' within 'out_dir' directory
dir.create(file.path(out_dir,"model_output"))


#---------------------------------------
##6 - Run model:

#-----------------------------------------------
##RF

model.out_vri <- wetland_model(qdatafn = attributed_csv_vri,
                                  model.type = "RF",
                                  model.folder = file.path(out_dir,"model_output"),
                                  unique.rowname = "OBJECTID_UNIQUE",
                                  predList = predList_vri,
                                  predFactor = FALSE,
                                  response.name = "pres_nd",
                                  response.type = "binary",
                                  seed = 1,
                                  aoi.col = NULL)

wetland_map(model.out = model.out_vri,
            model.folder = file.path(out_dir,"model_output"),
            rastLUTfn = rastLUT_vri,
            aoi = NULL,
            aoi.col = NULL)

elk_model_output_vri <- raster ('./wetlandmapr/output01/model_output/20220419-093547/20220419-093547_map.img')

raster::crs(elk_model_output_vri) <- "EPSG:3005"


plot(elk_model_output_vri)
plot(clip_points, add=TRUE)

crs(elk_model_output_vri)
writeRaster(elk_model_output_vri,
            filename = "vri_elkmodel","GTiff")
# #old school - issues with the wetland model:
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to
prevent printing of the R code that generated the plot.
